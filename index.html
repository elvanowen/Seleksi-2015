<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Spatial Database</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px;
      }
      button{
          z-index: 100;
          position: relative;
          top: 10px;
          left: 10px;
      }
      #add-virus{
          margin-right: 20px;
      }
    </style>
    <link rel="stylesheet" type="text/css" href="lib/bootstrap/css/bootstrap.min.css">
    <script src="lib/jquery.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
    <script>
    var poly;
    var map;
    var addVirus = 0;
    var markers = [];
    var apoteks, viruses;

    function initialize() {
      var mapOptions = {
        zoom: 5,
        center: new google.maps.LatLng(0.1750, 118.8283)
      };

      map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
      
      google.maps.event.addListener(map, 'click', addLatLng);
      getApoteks();
      //getViruses();
      //getInfected();
    }

    function addLatLng(event) {
        if (addVirus === 1){
            var marker = new google.maps.Marker({
              position: event.latLng,
              title: "TarikMang Virus",
              map: map
            });
            
            markers.push(marker);
            console.log(event.latLng);
        }
    }

    function toggleAddVirus(){
        addVirus = 1 - addVirus;
        if (addVirus === 0){
            for (var i = 0; i < markers.length; i++) {
              markers[i].setMap(null);
            }

            markers = [];
            document.getElementById("add-virus").style.display = "";
            document.getElementById("done").style.display = "none";
            document.getElementById("cancel").style.display = "none";
        }else{
            document.getElementById("add-virus").style.display = "none";
            document.getElementById("done").style.display = "";
            document.getElementById("cancel").style.display = "";
        }
    }

    function addViruses(){
        console.log(markersPosition);
        postViruses();
        toggleAddVirus();
    }
  
    function getApoteks(){
        console.log("getApoteks");
        $.ajax({
            url: 'http://localhost:8080/apoteks',
            type: "GET",
            dataType: "json",
            success: function(result){
              apoteks = result;
              var image = 'img/angel.png';

              for (var i in apoteks) {
                console.log(new google.maps.LatLng(parseFloat(apoteks[i].lat),parseFloat(apoteks[i].lng)));
                var marker = new google.maps.Marker({
                  position: new google.maps.LatLng(parseFloat(apoteks[i].lat),parseFloat(apoteks[i].lng)),
                  map: map,
                  visible: true,
                  //icon: image,
                  title: apoteks[i].name
                });
              }
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
            },
            beforeSend: function(){
            },
            complete: function(){
            }
        });
    }
  
    function getViruses(){
        console.log("getViruses");
        $.ajax({
            url: 'http://localhost:8080/viruses',
            type: "GET",
            dataType: "json",
            success: function(result){
              viruses = result;
              var image = 'img/devil.png';
          
              for (var i in viruses) {
                var options = {
                  strokeColor: '#FF0000',
                  strokeOpacity: 0.8,
                  strokeWeight: 2,
                  fillColor: '#FF0000',
                  fillOpacity: 0.35,
                  map: map,
                  center: new google.maps.LatLng(parseFloat(viruses[i].lat),parseFloat(viruses[i].lng)),
                  radius: 111302.62
                };
                new google.maps.Circle(options);

                var marker = new google.maps.Marker({
                  position: new google.maps.LatLng(parseFloat(viruses[i].lat),parseFloat(viruses[i].lng)),
                  map: map,
                  icon: image,
                  title: "TarikMang Virus"
                });
              }
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
            },
            beforeSend: function(){
            },
            complete: function(){
            }
        });
    }
  
    function getInfected(){
        console.log("getInfected");
        $.ajax({
            url: 'http://localhost:8080/nearestApotek',
            type: "GET",
            //dataType: "json",
            success: function(result){
              //apoteks = result;
              console.log(result);
          
              
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
            },
            beforeSend: function(){
            },
            complete: function(){
            }
        });
    }
  
    function postViruses(){
        console.log("postViruses");
        $.ajax({
            url: 'http://localhost:8080/addViruses',
            type: "POST",
            //dataType: "json",
            success: function(result){
              //apoteks = result;
              console.log(result);
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
            },
            beforeSend: function(){
            },
            complete: function(){
            }
        });
    }
    google.maps.event.addDomListener(window, 'load', initialize);
  </script>
  </head>
  <body>
    <div style="position: absolute">
      <button id="add-virus" onclick="toggleAddVirus()" class="btn btn-primary">Add Virus</button>
      <button id="done" onclick="addViruses()" class="btn btn-success" style="display:none; margin-right:10px">Done</button>
      <button id="cancel" onclick="toggleAddVirus()" class="btn btn-danger" style="display:none">Cancel</button>
    </div>
    <div id="map-canvas"></div>
  </body>
</html>